# タイトル重複問題 修正完了レポート

**作成日時**: 2026年2月2日  
**対象**: ieltsconsult.netlify.app  
**修正内容**: タイトルが1回だけ表示され、広告要素が削除されるように修正

---

## 1. 実施した修正内容

### 1.1 `sanitizeHtml`の設定変更

**ファイル**: `lib/posts.ts`  
**変更箇所**: 38-59行目

**変更内容**:
- `allowedTags`から`h1`を削除
- これにより、`sanitizeHtml`処理でH1タグが自動的に削除される

**変更前**:
```typescript
allowedTags: sanitizeHtml.defaults.allowedTags.concat([
  'img',
  'figure',
  'figcaption',
  'h1',  // ← 削除
  'h2',
  'h3',
  'h4',
  'h5',
  'h6',
]),
```

**変更後**:
```typescript
allowedTags: sanitizeHtml.defaults.allowedTags.concat([
  'img',
  'figure',
  'figcaption',
  // 'h1', // 記事本文内のH1は削除するため、許可しない
  'h2',
  'h3',
  'h4',
  'h5',
  'h6',
]),
```

**理由**:
- `sanitizeHtml`の設定でH1を許可していると、削除したH1が復活する可能性がある
- H1を許可しないことで、`sanitizeHtml`処理で自動的にH1が削除される

---

### 1.2 H1削除処理の強化

**ファイル**: `lib/posts.ts`  
**変更箇所**: 99-126行目

**変更内容**:
- 複数のパターンでH1タグを削除
- `sanitizeHtml`処理前と処理後の両方で削除

**追加した処理**:
1. 標準的なH1タグの削除
2. H1タグの前後に空白がある場合の削除
3. コンテンツの先頭にH1がある場合の削除
4. `sanitizeHtml`処理後にも再度削除

**変更前**:
```typescript
content = content.replace(/<h1[^>]*>[\s\S]*?<\/h1>\s*/i, '');
// ... sanitizeHtml処理 ...
content = content.replace(/<h1[^>]*>[\s\S]*?<\/h1>\s*/i, '');
```

**変更後**:
```typescript
// 複数の方法で確実にH1タグを削除
content = content.replace(/<h1[^>]*>[\s\S]*?<\/h1>\s*/i, '');
content = content.replace(/\s*<h1[^>]*>[\s\S]*?<\/h1>\s*/i, '');
content = content.replace(/^<h1[^>]*>[\s\S]*?<\/h1>\s*/im, '');
// ... sanitizeHtml処理 ...
// サニタイズ後もH1が残っている可能性があるため、再度複数の方法で削除
content = content.replace(/<h1[^>]*>[\s\S]*?<\/h1>\s*/i, '');
content = content.replace(/\s*<h1[^>]*>[\s\S]*?<\/h1>\s*/i, '');
content = content.replace(/^<h1[^>]*>[\s\S]*?<\/h1>\s*/im, '');
```

**理由**:
- 異なる形式のH1タグ（前後に空白がある、コンテンツの先頭にある等）に対応
- `sanitizeHtml`処理後にも再度削除することで、確実にH1を除去

---

### 1.3 広告要素削除処理の強化

**ファイル**: `lib/posts.ts`  
**変更箇所**: 107-133行目

**変更内容**:
- より包括的なパターンで広告要素を削除
- `sanitizeHtml`処理前と処理後の両方で削除

**追加した処理**:
1. `ad-container`クラスを含む`<div>`の削除
2. `ad-slot`クラスを含む`<div>`の削除
3. `adsbygoogle`クラスを含む`<ins>`の削除
4. `ad-`で始まるクラスを含む`<div>`の削除（より包括的）
5. `adsbygoogle`を含むすべての要素の削除
6. `sanitizeHtml`処理後にも再度削除

**変更前**:
```typescript
content = content.replace(/<div[^>]*class="[^"]*ad-container[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
content = content.replace(/<ins[^>]*class="[^"]*adsbygoogle[^"]*"[^>]*>[\s\S]*?<\/ins>/gi, '');
content = content.replace(/<div[^>]*class="[^"]*ad-slot[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
```

**変更後**:
```typescript
// より包括的なパターンで削除
content = content.replace(/<div[^>]*class="[^"]*ad-container[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
content = content.replace(/<div[^>]*class="[^"]*ad-slot[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
content = content.replace(/<ins[^>]*class="[^"]*adsbygoogle[^"]*"[^>]*>[\s\S]*?<\/ins>/gi, '');
// class属性にad-が含まれる要素も削除
content = content.replace(/<div[^>]*class="[^"]*ad-[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
// adsbygoogleを含むすべての要素を削除
content = content.replace(/<[^>]*adsbygoogle[^>]*>[\s\S]*?<\/[^>]+>/gi, '');
// ... sanitizeHtml処理 ...
// サニタイズ後も広告要素が残っている可能性があるため、再度削除
content = content.replace(/<div[^>]*class="[^"]*ad-container[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
content = content.replace(/<div[^>]*class="[^"]*ad-slot[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
content = content.replace(/<ins[^>]*class="[^"]*adsbygoogle[^"]*"[^>]*>[\s\S]*?<\/ins>/gi, '');
content = content.replace(/<div[^>]*class="[^"]*ad-[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
content = content.replace(/<[^>]*adsbygoogle[^>]*>[\s\S]*?<\/[^>]+>/gi, '');
```

**理由**:
- より包括的なパターンで広告要素を削除
- `sanitizeHtml`処理後にも再度削除することで、確実に広告要素を除去

---

### 1.4 デバッグログの改善

**ファイル**: `lib/posts.ts`  
**変更箇所**: 135-147行目

**変更内容**:
- `adsbygoogle`のカウントも追加
- より詳細な警告メッセージを出力

---

## 2. 修正の効果

### 2.1 H1削除の確実性向上

- **JSDOM削除**: DOM操作で確実に削除
- **正規表現削除（3パターン）**: 異なる形式のH1に対応
- **sanitizeHtml設定**: H1を許可しないことで自動削除
- **最終削除（3パターン）**: `sanitizeHtml`処理後にも再度削除

**合計**: 7回の削除処理で、確実にH1を除去

### 2.2 広告要素削除の確実性向上

- **削除パターンの拡張**: より包括的な正規表現を使用
- **sanitizeHtml処理後の再削除**: 確実に広告要素を除去

**合計**: 10回の削除処理で、確実に広告要素を除去

---

## 3. 変更ファイル

### 3.1 変更されたファイル

- `lib/posts.ts`: H1削除処理と広告要素削除処理を強化

### 3.2 変更されていないファイル

- `app/posts/[slug]/page.tsx`: 変更なし（ページ側のH1は維持）
- `lib/html-posts.ts`: 未使用のため変更なし

---

## 4. 動作確認手順

### 4.1 ビルドキャッシュのクリア（重要）

```bash
# .nextディレクトリを削除
rm -rf .next

# 再ビルド
npm run build
```

### 4.2 開発サーバーでの確認

```bash
# 開発サーバーを起動
npm run dev

# ブラウザで記事ページを開く
# http://localhost:3000/posts/nc8f873763df6

# コンソールに警告が表示されないことを確認
```

### 4.3 ブラウザでのDOM確認

1. 記事ページを開く
2. 開発者ツールを開く（F12）
3. コンソールタブで以下を実行：
   ```javascript
   // H1タグの数を確認
   const h1Elements = document.querySelectorAll('h1');
   console.log('H1タグの数:', h1Elements.length);
   console.log('期待値: 1（ページ側のH1のみ）');
   
   // proseクラス内のH1を確認
   const proseDiv = document.querySelector('.prose');
   if (proseDiv) {
     const h1InProse = proseDiv.querySelectorAll('h1');
     console.log('prose内のH1タグの数:', h1InProse.length);
     console.log('期待値: 0（prose内にH1はない）');
   }
   
   // 広告要素を確認
   const adContainers = document.querySelectorAll('.ad-container');
   const adsbygoogle = document.querySelectorAll('[class*="adsbygoogle"]');
   console.log('ad-containerの数:', adContainers.length);
   console.log('adsbygoogleの数:', adsbygoogle.length);
   console.log('期待値: 0（HTMLコンテンツ内に広告要素はない）');
   ```

### 4.4 確認項目

- [ ] H1タグが1つだけ存在する（ページ側のH1のみ）
- [ ] `prose`クラス内にH1タグが含まれていない
- [ ] HTMLコンテンツ内に広告要素（`ad-container`, `adsbygoogle`等）が含まれていない
- [ ] タイトルが1回だけ表示される
- [ ] 記事本文が正しく表示される（H2-H6の見出しは残っている）

---

## 5. 期待される結果

### 5.1 タイトル表示

- ✅ ページ側のH1が1つだけ表示される
- ✅ HTMLコンテンツ内のH1は削除される
- ✅ タイトルが1回だけ表示される

### 5.2 広告要素

- ✅ HTMLコンテンツ内の広告要素が削除される
- ✅ ページ側の広告スロット（`<AdSlot>`コンポーネント）は維持される

### 5.3 記事本文

- ✅ H2-H6の見出しは正しく表示される
- ✅ その他のHTML要素（画像、段落等）は正しく表示される

---

## 6. 変更diff

```diff
--- a/lib/posts.ts
+++ b/lib/posts.ts
@@ -38,12 +38,13 @@ const additionsDirectory = path.join(process.cwd(), 'content/additions');
 
 // HTMLのサニタイズ設定
+// 注意: h1はallowedTagsから除外（記事本文内のH1を削除するため）
+// H2-H6は許可（記事本文内の見出しとして使用）
 const sanitizeOptions: sanitizeHtml.IOptions = {
   allowedTags: sanitizeHtml.defaults.allowedTags.concat([
     'img',
     'figure',
     'figcaption',
-    'h1',
+    // 'h1', // 記事本文内のH1は削除するため、許可しない
     'h2',
     'h3',
     'h4',
@@ -97,22 +98,50 @@ async function getPostFromHtml(slug: string): Promise<Post | null> {
     // H1削除後のinnerHTMLを取得
     let content = bodyElement?.innerHTML || '';
     
-    // フォールバック: 正規表現でも確実に最初のh1タグを削除
-    // [\s\S]を使用して改行を含むすべての文字にマッチ（.*?では改行にマッチしない場合がある）
+    // 複数の方法で確実にH1タグを削除
+    // 方法1: 標準的なH1タグ（属性あり/なし、改行あり/なし）
     content = content.replace(/<h1[^>]*>[\s\S]*?<\/h1>\s*/i, '');
+    // 方法2: H1タグの前後に空白や改行がある場合
+    content = content.replace(/\s*<h1[^>]*>[\s\S]*?<\/h1>\s*/i, '');
+    // 方法3: コンテンツの先頭にH1がある場合
+    content = content.replace(/^<h1[^>]*>[\s\S]*?<\/h1>\s*/im, '');
     
-    // 広告関連の要素を削除（ad-container, adsbygoogle等）
-    content = content.replace(/<div[^>]*class="[^"]*ad-container[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
-    content = content.replace(/<ins[^>]*class="[^"]*adsbygoogle[^"]*"[^>]*>[\s\S]*?<\/ins>/gi, '');
-    content = content.replace(/<div[^>]*class="[^"]*ad-slot[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
+    // 広告関連の要素を削除（ad-container, adsbygoogle等）
+    // より包括的なパターンで削除
+    content = content.replace(/<div[^>]*class="[^"]*ad-container[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
+    content = content.replace(/<div[^>]*class="[^"]*ad-slot[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
+    content = content.replace(/<ins[^>]*class="[^"]*adsbygoogle[^"]*"[^>]*>[\s\S]*?<\/ins>/gi, '');
+    // class属性にad-が含まれる要素も削除
+    content = content.replace(/<div[^>]*class="[^"]*ad-[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
+    // adsbygoogleを含むすべての要素を削除
+    content = content.replace(/<[^>]*adsbygoogle[^>]*>[\s\S]*?<\/[^>]+>/gi, '');
     
     // 画像パスを修正（assets/... → /assets/...）
     content = content.replace(/src="assets\//g, 'src="/assets/');
     
     // HTMLをサニタイズ
     content = sanitizeHtml(content, sanitizeOptions);
     
-    // サニタイズ後もH1が残っている可能性があるため、再度削除
+    // サニタイズ後もH1が残っている可能性があるため、再度複数の方法で削除
     content = content.replace(/<h1[^>]*>[\s\S]*?<\/h1>\s*/i, '');
+    content = content.replace(/\s*<h1[^>]*>[\s\S]*?<\/h1>\s*/i, '');
+    content = content.replace(/^<h1[^>]*>[\s\S]*?<\/h1>\s*/im, '');
+    
+    // サニタイズ後も広告要素が残っている可能性があるため、再度削除
+    content = content.replace(/<div[^>]*class="[^"]*ad-container[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
+    content = content.replace(/<div[^>]*class="[^"]*ad-slot[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
+    content = content.replace(/<ins[^>]*class="[^"]*adsbygoogle[^"]*"[^>]*>[\s\S]*?<\/ins>/gi, '');
+    content = content.replace(/<div[^>]*class="[^"]*ad-[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
+    content = content.replace(/<[^>]*adsbygoogle[^>]*>[\s\S]*?<\/[^>]+>/gi, '');
     
     // デバッグ用: 開発環境でのみログを出力
     if (process.env.NODE_ENV === 'development') {
       const h1Count = (content.match(/<h1[^>]*>/gi) || []).length;
       const adContainerCount = (content.match(/ad-container/gi) || []).length;
+      const adsbygoogleCount = (content.match(/adsbygoogle/gi) || []).length;
       if (h1Count > 0 || adContainerCount > 0 || adsbygoogleCount > 0) {
         console.warn(`[${slug}] 警告: H1タグ(${h1Count}個)、ad-container(${adContainerCount}個)、adsbygoogle(${adsbygoogleCount}個)が残っています`);
```

---

## 7. 変更理由（箇条書き）

1. **`sanitizeHtml`の設定から`h1`を削除**: H1を許可しないことで、`sanitizeHtml`処理で自動的にH1が削除される
2. **H1削除処理を複数のパターンで実施**: 異なる形式のH1タグ（前後に空白がある、コンテンツの先頭にある等）に対応
3. **`sanitizeHtml`処理後にもH1を再削除**: 確実にH1を除去するため
4. **広告要素削除処理を強化**: より包括的なパターンで広告要素を削除
5. **`sanitizeHtml`処理後にも広告要素を再削除**: 確実に広告要素を除去するため
6. **デバッグログの改善**: `adsbygoogle`のカウントも追加し、より詳細な警告を出力

---

## 8. 確認手順

### 8.1 ビルドキャッシュのクリア（必須）

```bash
# .nextディレクトリを削除
rm -rf .next

# 再ビルド
npm run build
```

### 8.2 開発サーバーでの確認

```bash
# 開発サーバーを起動
npm run dev

# ブラウザで記事ページを開く
# http://localhost:3000/posts/nc8f873763df6
```

### 8.3 ブラウザでのDOM確認

1. 記事ページを開く
2. 開発者ツールを開く（F12）
3. コンソールタブで以下を実行：
   ```javascript
   // H1タグの数を確認
   const h1Elements = document.querySelectorAll('h1');
   console.log('H1タグの数:', h1Elements.length);
   console.log('期待値: 1（ページ側のH1のみ）');
   
   // proseクラス内のH1を確認
   const proseDiv = document.querySelector('.prose');
   if (proseDiv) {
     const h1InProse = proseDiv.querySelectorAll('h1');
     console.log('prose内のH1タグの数:', h1InProse.length);
     console.log('期待値: 0（prose内にH1はない）');
     
     // prose内のH1が存在する場合、その内容を表示
     if (h1InProse.length > 0) {
       h1InProse.forEach((h1, index) => {
         console.log(`[${index + 1}]`, h1.textContent);
         console.log('  完全なHTML:', h1.outerHTML);
       });
     }
   }
   
   // 広告要素を確認
   const adContainers = document.querySelectorAll('.ad-container');
   const adsbygoogle = document.querySelectorAll('[class*="adsbygoogle"]');
   console.log('ad-containerの数:', adContainers.length);
   console.log('adsbygoogleの数:', adsbygoogle.length);
   console.log('期待値: 0（HTMLコンテンツ内に広告要素はない）');
   ```

### 8.4 確認項目チェックリスト

- [ ] H1タグが1つだけ存在する（ページ側のH1のみ）
- [ ] `prose`クラス内にH1タグが含まれていない
- [ ] HTMLコンテンツ内に広告要素（`ad-container`, `adsbygoogle`等）が含まれていない
- [ ] タイトルが1回だけ表示される
- [ ] 記事本文が正しく表示される（H2-H6の見出しは残っている）
- [ ] 開発サーバーのコンソールに警告が表示されない

---

## 9. 注意事項

### 9.1 `sanitizeHtml`の設定変更について

- `h1`を`allowedTags`から削除したため、記事本文内のすべてのH1タグが削除されます
- これは意図的な動作です（ページ側のH1のみを表示するため）
- H2-H6の見出しは引き続き表示されます

### 9.2 広告要素について

- HTMLコンテンツ内の広告要素は削除されます
- ページ側の広告スロット（`<AdSlot>`コンポーネント）は維持されます
- これは意図的な動作です（ページ側で広告を制御するため）

---

## 10. 次のステップ

1. **ビルドキャッシュのクリアと再ビルド**
2. **開発サーバーでの動作確認**
3. **ブラウザでのDOM確認**
4. **問題が解決しない場合、追加の調査を実施**

---

**レポート作成日**: 2026年2月2日  
**作成者**: AI Assistant  
**修正完了**: ✅
