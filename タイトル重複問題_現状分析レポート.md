# タイトル重複問題 現状分析レポート

**作成日時**: 2026年2月2日  
**対象**: ieltsconsult.netlify.app  
**問題**: 記事ページでタイトルが2回表示される + 広告要素が残っている

---

## 1. 問題の概要

### 1.1 観察された症状
- 記事詳細ページ（`/posts/[slug]`）で、同一のタイトルが2回表示される
- 1回目: ページコンポーネント側のH1（`app/posts/[slug]/page.tsx`の194行目）
  ```tsx
  <h1 className="text-3xl md:text-4xl lg:text-5xl font-semibold tracking-tight mb-4">
    {post.title}
  </h1>
  ```
- 2回目: 記事本文（`post.content`）内に含まれるH1タグ
  ```tsx
  <div className="prose prose-lg dark:prose-invert max-w-none mb-12"
       dangerouslySetInnerHTML={{ __html: post.content }} />
  ```
- 広告要素（`ad-container`等）がHTMLコンテンツ内に残っている

### 1.2 影響範囲
- すべてのHTML記事（`n*.html`形式のファイル）
- 特に確認された記事: `nc8f873763df6`（IELTSライティング Task 1）

---

## 2. デバッグ結果

### 2.1 処理フローの確認

**テスト対象**: `n1a971fb03450.html`, `nc8f873763df6.html`

#### ステップ1: 元のHTMLファイル
- ✅ H1タグが1つ存在することを確認
- ✅ 広告要素（`ad-container`, `adsbygoogle`）は元のHTMLに含まれていない

#### ステップ2: JSDOMパース後
- ✅ `body`内にH1タグが1つ存在することを確認

#### ステップ3: JSDOMでH1削除後
- ✅ H1タグが削除され、`content`にH1が含まれていないことを確認
- ✅ `content`の長さが減少（28272 bytes ← 28458 bytes）

#### ステップ4: 正規表現でH1削除後
- ⚠️ **注意**: 正規表現が機能していないように見えるが、これはH1が既にJSDOMで削除されているため
- ✅ H1は含まれていない

#### ステップ5: 広告要素削除後
- ✅ 広告要素は元々含まれていないため、削除するものがない

#### ステップ6: sanitizeHtml処理後
- ✅ H1は含まれていない
- ⚠️ `content`の長さが増加（28360 bytes ← 28272 bytes）
  - **原因**: `sanitizeHtml`がHTMLを正規化している可能性

#### ステップ7: 最終的なH1削除処理後
- ✅ H1タグは含まれていない

### 2.2 最終結果

**処理後のコンテンツ**:
- ✅ H1タグの数: 0
- ✅ ad-containerの数: 0
- ✅ adsbygoogleの数: 0
- ✅ コンテンツの先頭は`<figure>`タグから始まっている（H1は含まれていない）

**結論**: `lib/posts.ts`の処理自体は**正しく動作している**

---

## 3. 問題の原因仮説

### 仮説1: ビルドキャッシュの問題 ⭐⭐⭐⭐⭐

**根拠**:
- デバッグスクリプトでは、`lib/posts.ts`の処理が正しく動作している
- しかし、実際のページではタイトルが2回表示されている
- Next.jsのビルドキャッシュ（`.next`ディレクトリ）が古い状態を保持している可能性

**確認方法**:
```bash
# ビルドキャッシュをクリア
rm -rf .next
npm run build
```

**推奨度**: ⭐⭐⭐⭐⭐（最有力）

---

### 仮説2: 実際のページレンダリング時に別の処理が実行されている ⭐⭐⭐⭐

**根拠**:
- `app/posts/[slug]/page.tsx`で`post.content`を`dangerouslySetInnerHTML`で直接挿入している
- クライアント側で何らかの処理が実行されている可能性
- または、サーバー側で`getPostBySlug`が異なる結果を返している可能性

**確認方法**:
- ブラウザの開発者ツールで実際のDOMを確認
- `document.querySelectorAll('h1')`でH1タグの数を確認
- 各H1タグの親要素を確認
- サーバー側ログを追加して、実際に生成される`post.content`を確認

**推奨度**: ⭐⭐⭐⭐

---

### 仮説3: `sanitizeHtml`の設定でH1が許可されている ⭐⭐⭐

**根拠**:
- `lib/posts.ts`の39-59行目で、`sanitizeOptions`に`h1`が`allowedTags`に含まれている
- 削除したH1が、`sanitizeHtml`の処理で復活している可能性（ただし、デバッグ結果では復活していない）

**該当コード**:
```typescript
const sanitizeOptions: sanitizeHtml.IOptions = {
  allowedTags: sanitizeHtml.defaults.allowedTags.concat([
    'h1',  // ← H1が許可されている
    'h2',
    'h3',
    // ...
  ]),
};
```

**確認結果**: デバッグスクリプトでは、`sanitizeHtml`処理後もH1は含まれていない

**推奨度**: ⭐⭐⭐

---

### 仮説4: HTMLコンテンツ内に別の形式でH1が含まれている ⭐⭐

**根拠**:
- 通常の`<h1>`タグではなく、`<h1 class="...">`のような属性付きのH1が含まれている可能性
- 正規表現が属性付きのH1にマッチしていない可能性

**確認結果**: デバッグスクリプトでは、すべてのH1タグが正しく削除されている

**推奨度**: ⭐⭐

---

### 仮説5: クライアント側のJavaScriptでH1が追加されている ⭐

**根拠**:
- クライアント側のスクリプト（AdSense等）がH1を追加している可能性

**確認方法**:
- ブラウザの開発者ツールで、ページ読み込み後のDOMの変化を確認
- ネットワークタブで、追加のスクリプトが読み込まれているか確認

**推奨度**: ⭐

---

## 4. 実際のページでの確認が必要な項目

### 4.1 ブラウザの開発者ツールでの確認

1. **DOM構造の確認**
   ```javascript
   // コンソールで実行
   const h1Elements = document.querySelectorAll('h1');
   console.log('H1タグの数:', h1Elements.length);
   h1Elements.forEach((h1, index) => {
     console.log(`[${index + 1}]`, h1.textContent);
     console.log('  親要素:', h1.parentElement?.className);
     console.log('  完全なHTML:', h1.outerHTML);
   });
   ```

2. **コンテンツエリアの確認**
   ```javascript
   // proseクラスを持つdiv内のH1を確認
   const proseDiv = document.querySelector('.prose');
   if (proseDiv) {
     const h1InProse = proseDiv.querySelectorAll('h1');
     console.log('prose内のH1タグの数:', h1InProse.length);
     h1InProse.forEach((h1, index) => {
       console.log(`[${index + 1}]`, h1.textContent);
       console.log('  完全なHTML:', h1.outerHTML);
       console.log('  親要素:', h1.parentElement?.className);
     });
   }
   ```

3. **広告要素の確認**
   ```javascript
   // ad-containerを確認
   const adContainers = document.querySelectorAll('.ad-container');
   console.log('ad-containerの数:', adContainers.length);
   adContainers.forEach((ad, index) => {
     console.log(`[${index + 1}]`, ad.outerHTML.substring(0, 200));
     console.log('  親要素:', ad.parentElement?.className);
   });
   ```

### 4.2 サーバー側での確認

1. **実際に生成される`post.content`の確認**
   - `lib/posts.ts`に開発環境でのみログを出力するコードを追加済み
   - 開発サーバー起動時に、コンソールに警告が表示される

2. **ビルド時の確認**
   ```bash
   # ビルドログを確認
   npm run build 2>&1 | tee build.log
   ```

---

## 5. 推奨される対応策

### 5.1 即座に実施すべき対応

1. **ビルドキャッシュのクリア**
   ```bash
   # .nextディレクトリを削除
   rm -rf .next
   # 再ビルド
   npm run build
   ```

2. **実際のページでのDOM確認**
   - ブラウザの開発者ツールで、実際に表示されているH1タグを確認
   - 各H1タグの親要素とクラス名を確認
   - 上記のJavaScriptコードを実行して、詳細を確認

3. **開発サーバーでのログ確認**
   ```bash
   npm run dev
   # 記事ページにアクセスして、コンソールに警告が表示されるか確認
   ```

### 5.2 根本的な解決策

1. **H1削除処理の強化**
   - 現在の処理は正しく動作しているが、念のため複数のパターンで削除を試みる
   - `sanitizeHtml`の設定でH1を許可しないようにする（ただし、これは他のH2-H6にも影響する可能性がある）

2. **広告要素の削除処理の改善**
   - 現在の正規表現がすべてのパターンにマッチするか確認
   - より包括的な正規表現を使用

3. **テストの追加**
   - ユニットテストを追加して、H1削除処理が正しく動作することを確認

---

## 6. 次のステップ

### 優先度: 高

1. **ビルドキャッシュのクリアと再ビルド**
   ```bash
   rm -rf .next
   npm run build
   npm run dev
   ```

2. **実際のページでのDOM確認**
   - ブラウザで記事ページを開く
   - 開発者ツールのコンソールで上記のJavaScriptコードを実行
   - 結果をレポートに追加

3. **開発サーバーでのログ確認**
   - 記事ページにアクセスして、コンソールに警告が表示されるか確認
   - 警告が表示された場合、その内容を確認

### 優先度: 中

4. **問題が解決しない場合、追加の修正を実施**
   - `sanitizeHtml`の設定を変更
   - H1削除処理をさらに強化

---

## 7. 補足情報

### 7.1 現在の実装状況

**`lib/posts.ts`の処理フロー**:
1. JSDOMでH1を削除 ✅
2. `innerHTML`を取得 ✅
3. 正規表現でH1を削除 ✅
4. 広告要素を削除 ✅
5. 画像パスを修正 ✅
6. `sanitizeHtml`でサニタイズ ✅
7. 最終的なH1削除 ✅
8. 開発環境でのログ出力 ✅（追加済み）

**デバッグ結果**: すべてのステップでH1が正しく削除されている

### 7.2 考えられる問題

1. **ビルドキャッシュ**: Next.jsの`.next`ディレクトリに古いビルド結果が残っている
2. **実際のレンダリング**: ブラウザで表示されているHTMLが、サーバー側で生成されたものと異なる
3. **クライアント側処理**: JavaScriptでH1が追加されている

### 7.3 追加されたデバッグ機能

`lib/posts.ts`に開発環境でのみログを出力するコードを追加しました：
- H1タグが残っている場合、警告を出力
- 広告要素が残っている場合、警告を出力
- 残っているH1タグの内容を表示

---

## 8. 確認手順

### 8.1 ビルドキャッシュのクリア

```bash
# .nextディレクトリを削除
rm -rf .next

# 再ビルド
npm run build
```

### 8.2 開発サーバーでの確認

```bash
# 開発サーバーを起動
npm run dev

# ブラウザで記事ページを開く
# http://localhost:3000/posts/nc8f873763df6

# コンソールに警告が表示されるか確認
```

### 8.3 ブラウザでのDOM確認

1. 記事ページを開く
2. 開発者ツールを開く（F12）
3. コンソールタブで以下を実行：
   ```javascript
   const h1Elements = document.querySelectorAll('h1');
   console.log('H1タグの数:', h1Elements.length);
   h1Elements.forEach((h1, index) => {
     console.log(`[${index + 1}]`, h1.textContent);
     console.log('  親要素:', h1.parentElement?.className);
     console.log('  完全なHTML:', h1.outerHTML);
   });
   
   const proseDiv = document.querySelector('.prose');
   if (proseDiv) {
     const h1InProse = proseDiv.querySelectorAll('h1');
     console.log('prose内のH1タグの数:', h1InProse.length);
     h1InProse.forEach((h1, index) => {
       console.log(`[${index + 1}]`, h1.textContent);
       console.log('  完全なHTML:', h1.outerHTML);
     });
   }
   ```

---

**レポート作成日**: 2026年2月2日  
**作成者**: AI Assistant  
**次回アクション**: ビルドキャッシュのクリアと実際のページでのDOM確認
