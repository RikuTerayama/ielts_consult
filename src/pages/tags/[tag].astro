---
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const tagSet = new Set();
  
  posts.forEach(post => {
    if (post.data.tags) {
      post.data.tags.forEach(tag => tagSet.add(tag));
    }
  });
  
  return Array.from(tagSet).map(tag => ({
    params: { tag: tag }
  }));
}

const { tag } = Astro.params;
const posts = await getCollection('blog');
const filteredPosts = posts
  .filter(post => post.data.tags && post.data.tags.includes(tag))
  .sort((a, b) => (b.data.pubDate || '').localeCompare(a.data.pubDate || ''));
---
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>タグ: #{tag} - IELTS Blog</title>
    <link rel="canonical" href={new URL(Astro.url, import.meta.env?.SITE || import.meta.env?.PUBLIC_SITE_URL || 'https://<your-site>.netlify.app').toString()} />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <main style="max-width: 920px; margin: 2rem auto; padding: 0 1rem;">
      <h1>タグ: #{tag}</h1>
      <div style="margin-bottom: 2rem;">
        <a href="/blog/" style="margin-right: 1rem;">← ブログ一覧</a>
        <a href="/tags/" style="margin-right: 1rem;">← タグ一覧</a>
        <a href="/categories/">カテゴリ一覧</a>
      </div>
      
      <p style="color: #666; margin-bottom: 2rem;">
        {filteredPosts.length}件の記事が見つかりました
      </p>
      
      <div style="margin-bottom: 2rem;">
        {filteredPosts.map(post => (
          <article style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
            <h2 style="margin: 0 0 0.5rem 0;">
              <a href={`/blog/${post.slug}/`} style="text-decoration: none; color: #333;">
                {post.data.title}
              </a>
            </h2>
            {post.data.pubDate && (
              <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.9rem;">
                公開日: {post.data.pubDate}
              </p>
            )}
            {post.data.description && (
              <p style="margin: 0 0 0.5rem 0; color: #555;">
                {post.data.description}
              </p>
            )}
            <div style="margin-top: 0.5rem;">
              {post.data.tags && post.data.tags.length > 0 && (
                <div style="margin-bottom: 0.5rem;">
                  <strong>タグ:</strong>
                  {post.data.tags.map(t => (
                    <a href={`/tags/${encodeURIComponent(t)}/`} style={`margin-left: 0.5rem; color: ${t === tag ? '#dc3545' : '#007bff'}; text-decoration: none; font-weight: ${t === tag ? 'bold' : 'normal'};`}>
                      #{t}
                    </a>
                  ))}
                </div>
              )}
              {post.data.category && (
                <div>
                  <strong>カテゴリ:</strong>
                  <a href={`/categories/${encodeURIComponent(post.data.category)}/`} style="margin-left: 0.5rem; color: #007bff; text-decoration: none;">
                    {post.data.category}
                  </a>
                </div>
              )}
            </div>
          </article>
        ))}
      </div>
      
      {filteredPosts.length === 0 && (
        <p style="text-align: center; color: #666; margin-top: 2rem;">
          このタグの記事が見つかりませんでした。
        </p>
      )}
    </main>
  </body>
</html>
